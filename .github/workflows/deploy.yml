name: deploy-and-e2e

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy repo to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "**/*,!**/.git/**,!**/node_modules/**"
          target: "~/plaque/"
          overwrite: true

      - name: Build and restart services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail
            cd "$HOME/plaque"
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            elif command -v docker-compose >/dev/null 2>&1; then
              COMPOSE="docker-compose"
            else
              echo "docker compose/docker-compose 不可用或无执行权限"
              exit 1
            fi
            PASSWORD="${{ secrets.SERVER_SUDO_PASSWORD }}"
            if [ -z "$PASSWORD" ]; then
              PASSWORD="${{ secrets.SERVER_PASSWORD }}"
            fi
            if sudo -n true 2>/dev/null; then
              SUDO_MODE="noninteractive"
            else
              SUDO_MODE="password"
            fi
            run_compose() {
              if [ "$SUDO_MODE" = "noninteractive" ]; then
                sudo -n $COMPOSE "$@"
              else
                if [ -n "$PASSWORD" ]; then
                  echo "$PASSWORD" | sudo -S $COMPOSE "$@"
                else
                  $COMPOSE "$@"
                fi
              fi
            }
            if ! docker info >/dev/null 2>&1; then
              if [ "$SUDO_MODE" = "noninteractive" ]; then
                sudo -n systemctl start docker || sudo -n service docker start || true
              else
                if [ -n "$PASSWORD" ]; then
                  echo "$PASSWORD" | sudo -S systemctl start docker || echo "$PASSWORD" | sudo -S service docker start || true
                fi
              fi
            fi
            run_compose down || true
            run_compose build --no-cache
            run_compose up -d
            for i in $(seq 1 20); do
              if curl -sf http://localhost/api/health >/dev/null 2>&1; then
                break
              fi
              sleep 3
            done
            echo "== Backend logs (last 80 lines) =="
            run_compose logs --tail=80 backend || true

      - name: E2E upload and analysis
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail
            cd "$HOME/plaque"
            if [ ! -f t1.png ]; then
              echo "t1.png not found, downloading a sample image..."
              if command -v curl >/dev/null 2>&1; then
                curl -L -o t1.png "https://via.placeholder.com/1280x960.png?text=dental+sample" || {
                  echo "failed to download sample image with curl" && exit 1;
                }
              elif command -v wget >/dev/null 2>&1; then
                wget -O t1.png "https://via.placeholder.com/1280x960.png?text=dental+sample" || {
                  echo "failed to download sample image with wget" && exit 1;
                }
              else
                echo "no curl or wget available to download sample image" && exit 1
              fi
            fi
            UPLOAD_JSON=$(curl -sS -m 60 -F "image=@t1.png" http://localhost/api/upload/upload)
            echo "$UPLOAD_JSON" > "$HOME/plaque/upload_response.json"
            IMAGE_ID=$(echo "$UPLOAD_JSON" | sed -n 's/.*"imageId":"\([^"]*\)".*/\1/p')
            if [ -z "$IMAGE_ID" ]; then
              echo "failed to parse imageId"
              exit 1
            fi
            ANALYSIS_JSON=$(curl -sS -m 120 http://localhost/api/upload/analysis/$IMAGE_ID)
            echo "$ANALYSIS_JSON" > "$HOME/plaque/analysis_result.json"

      - name: Fetch E2E results
        run: |
          set -euo pipefail
          sudo apt-get update >/dev/null 2>&1 || true
          sudo apt-get install -y sshpass >/dev/null 2>&1 || true
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -P 22 -o StrictHostKeyChecking=no "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/plaque/upload_response.json" ./ || true
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -P 22 -o StrictHostKeyChecking=no "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/plaque/analysis_result.json" ./ || true

      # Removed scp-action download steps. Use sshpass scp in previous step to fetch results.

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            upload_response.json
            analysis_result.json
          if-no-files-found: warn

      - name: Summarize E2E results
        run: |
          set -euo pipefail
          sudo apt-get update >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true
          echo "## 部署与E2E摘要" >> $GITHUB_STEP_SUMMARY
          if [ -f upload_response.json ]; then
            IMAGE_ID=$(jq -r '.data.imageId // .imageId // empty' upload_response.json)
            echo "- imageId: ${IMAGE_ID}" >> $GITHUB_STEP_SUMMARY
            echo "- upload_response.json: 大小 $(wc -c < upload_response.json) 字节" >> $GITHUB_STEP_SUMMARY
          else
            echo "- upload_response.json 不存在" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f analysis_result.json ]; then
            TEETH_COUNT=$(jq -r '.teethDetection | length' analysis_result.json)
            OVERALL_SCORE=$(jq -r '.diseaseAnalysis.overallScore // empty' analysis_result.json)
            PLAQUE_PERCENT=$(jq -r '.diseaseAnalysis.plaquePercentage // empty' analysis_result.json)
            echo "- 检测牙齿数量: ${TEETH_COUNT}" >> $GITHUB_STEP_SUMMARY
            echo "- 综合评分(overallScore): ${OVERALL_SCORE}" >> $GITHUB_STEP_SUMMARY
            echo "- 牙菌斑比例(plaquePercentage): ${PLAQUE_PERCENT}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "- analysis_result.json 不存在" >> $GITHUB_STEP_SUMMARY
          fi