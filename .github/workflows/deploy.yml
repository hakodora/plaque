name: deploy-and-e2e

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy repo to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "./"
          target: "$HOME/plaque/"

      - name: Build and restart services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail
            cd "$HOME/plaque"
            docker-compose down || true
            docker-compose build --no-cache
            docker-compose up -d
            for i in $(seq 1 20); do
              if curl -sf http://localhost/api/health >/dev/null 2>&1; then
                break
              fi
              sleep 3
            done

      - name: E2E upload and analysis
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail
            cd "$HOME/plaque"
            if [ ! -f t1.png ]; then
              echo "t1.png not found in repo root"
              exit 1
            fi
            UPLOAD_JSON=$(curl -sS -m 60 -F "image=@t1.png" http://localhost/api/upload/upload)
            echo "$UPLOAD_JSON" > "$HOME/plaque/upload_response.json"
            IMAGE_ID=$(echo "$UPLOAD_JSON" | sed -n 's/.*"imageId":"\([^"]*\)".*/\1/p')
            if [ -z "$IMAGE_ID" ]; then
              echo "failed to parse imageId"
              exit 1
            fi
            ANALYSIS_JSON=$(curl -sS -m 120 http://localhost/api/upload/analysis/$IMAGE_ID)
            echo "$ANALYSIS_JSON" > "$HOME/plaque/analysis_result.json"

      - name: Download upload_response.json
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "$HOME/plaque/upload_response.json"
          target: "./"

      - name: Download analysis_result.json
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "$HOME/plaque/analysis_result.json"
          target: "./"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            upload_response.json
            analysis_result.json